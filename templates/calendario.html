<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário Acadêmico</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.11/index.global.min.js'></script>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js'></script>

</head>

<body>
    <header>
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='lumi_logo.jpg') }}" alt="Logo Lumi" class="logo">
        </a>
    </header>

    <main class="calendar-page">
        
        <section class="calendar-section">
            <h1>Calendário Acadêmico</h1>
            <p>Selecione um dia no calendário ou utilize a busca para encontrar eventos.</p>

            <div id="calendar-wrapper">
                <div id="calendar"></div>
            </div>

            <div class="agenda-section">
                <input type="text" id="event-search" class="event-search" placeholder="Buscar evento na lista...">
                
                <div class="agenda-header">
                    <h2 id="event-list-title">Todos os Eventos</h2>
                    <button id="show-all-btn" class="simple-btn hidden">Mostrar Todos</button>
                </div>

                <div class="agenda-list" id="agenda-list">
                    {% if eventos_data %}
                        {% for evento in eventos_data %}
                        <div class="agenda-item" data-date="{{ evento.data_iso }}">
                            <div class="agenda-date">
                                <span class="agenda-day">{{ evento.data.split('/')[0] }}</span>
                                <span class="agenda-month">{{ evento.mes_curto }}</span>
                            </div>
                            <div class="agenda-details">
                                <h3 class="agenda-title">{{ evento.evento }}</h3>
                                <p class="agenda-full-date">{{ evento.data }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-events-message">Nenhum evento encontrado.</p>
                    {% endif %}
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. PREPARAÇÃO DOS DADOS ---
            const eventosData = {{ eventos_data|tojson }};

            const eventosFormatados = eventosData.map(evento => {
                return {
                    title: evento.evento,
                    start: evento.data_iso,
                };
            });

            // --- 2. INICIALIZAÇÃO DO FULLCALENDAR ---
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                
                initialView: 'dayGridMonth',
                locale: 'pt-br', // Esta linha agora vai funcionar por causa do script "locales-all"
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listWeek'
                },
                buttonText: { // Força a tradução dos botões se 'locale' falhar
                    today: 'Hoje',
                    month: 'Mês',
                    week: 'Semana',
                    list: 'Lista'
                },
                events: eventosFormatados,
                selectable: true,
                
                // --- AÇÃO AO CLICAR EM UM DIA DO CALENDÁRIO ---
                dateClick: function(info) {
                    filterEventsByDate(info.dateStr);
                    document.getElementById('agenda-list').scrollIntoView({ behavior: 'smooth' });

                    document.querySelectorAll('.fc-daygrid-day.fc-day-selected').forEach(el => {
                        el.classList.remove('fc-day-selected');
                    });
                    if (info.dayEl) { 
                        info.dayEl.classList.add('fc-day-selected');
                    }
                },
                 // --- AÇÃO AO CLICAR EM UM EVENTO (NO PRÓPRIO CALENDÁRIO) ---
                eventClick: function(info) {
                    info.jsEvent.preventDefault(); 
                    const dataISO = info.event.start.toISOString().split('T')[0];
                    filterEventsByDate(dataISO);
                    document.getElementById('agenda-list').scrollIntoView({ behavior: 'smooth' });
                     
                    document.querySelectorAll('.fc-daygrid-day.fc-day-selected').forEach(el => {
                        el.classList.remove('fc-day-selected');
                    });
                     if (info.el && info.el.closest('.fc-daygrid-day')) {
                        info.el.closest('.fc-daygrid-day').classList.add('fc-day-selected');
                    }
                },
            });

            calendar.render();


            // --- 3. FUNCIONALIDADE DA LISTA DE AGENDA ---
            const searchInput = document.getElementById('event-search');
            const allEventItems = document.querySelectorAll('.agenda-item');
            const eventListTitle = document.getElementById('event-list-title');
            const showAllBtn = document.getElementById('show-all-btn');

            function showAllEvents() {
                eventListTitle.textContent = 'Todos os Eventos';
                showAllBtn.classList.add('hidden');
                searchInput.value = ''; 
                allEventItems.forEach(item => {
                    item.style.display = 'flex';
                });
                document.querySelectorAll('.fc-daygrid-day.fc-day-selected').forEach(el => {
                    el.classList.remove('fc-day-selected');
                });
            }

            function filterEventsByDate(dateISO) {
                let count = 0;
                const [year, month, day] = dateISO.split('-');
                const formattedDate = `${day}/${month}/${year}`;
                
                eventListTitle.textContent = `Eventos para ${formattedDate}`;
                showAllBtn.classList.remove('hidden');
                searchInput.value = ''; 

                allEventItems.forEach(item => {
                    if (item.dataset.date === dateISO) {
                        item.style.display = 'flex';
                        count++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                if (count === 0) {
                     eventListTitle.textContent = `Nenhum evento para ${formattedDate}`;
                }
            }
            
            showAllBtn.addEventListener('click', showAllEvents);

            searchInput.addEventListener('keyup', function () {
                const filter = searchInput.value.toLowerCase();
                showAllBtn.classList.add('hidden'); 

                eventListTitle.textContent = 
                    filter === '' ? 'Todos os Eventos' : 'Resultados da Busca';

                let foundCount = 0;
                allEventItems.forEach(item => {
                    const eventoText = item
                        .querySelector('.agenda-title')
                        .textContent.toLowerCase();
                    const fullDateText = item
                        .querySelector('.agenda-full-date')
                        .textContent.toLowerCase();

                    if (eventoText.includes(filter) || fullDateText.includes(filter)) {
                        item.style.display = 'flex';
                        foundCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                if (foundCount === 0 && filter !== '') {
                    eventListTitle.textContent = 'Nenhum resultado encontrado.';
                } else if (filter === '') {
                    showAllEvents();
                }

                document.querySelectorAll('.fc-daygrid-day.fc-day-selected').forEach(el => {
                    el.classList.remove('fc-day-selected');
                });
            });
        });
    </script>
</body>
</html>