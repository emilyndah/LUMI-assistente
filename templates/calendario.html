<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário Acadêmico</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js'></script>

</head>

<body>
    <header>
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='lumi_logo.jpg') }}" alt="Logo Lumi" class="logo">
        </a>
          <div class="user-area">
            {% if current_user.is_authenticated %}
                <span class="welcome-msg">Olá, {{ current_user.username }}!</span>
                <a href="{{ url_for('profile') }}" class="profile-link" title="Meu Perfil">
                    <div class="profile-icon">{{ current_user.username[0]|upper }}</div>
                </a>
                <a href="{{ url_for('logout') }}" class="logout-link" title="Sair">Logout</a>
            {% endif %}
        </div>
    </header>

    <main class="calendar-page">
        <section class="calendar-section">
            
            <h1>Calendário Acadêmico</h1>
            <p>Selecione um dia no calendário ou utilize a busca para encontrar eventos.</p>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <ul class="flash-messages" style="list-style: none; padding: 0; margin-bottom: 20px;">
                {% for category, message in messages %}
                  {% set category_class = 'warning' if category == 'message' else category %}
                  <li class="{{ category_class }}" style="padding: 10px 15px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em; text-align: left; border: 1px solid transparent; background-color: #fff3cd; color: #856404; border-color: #ffeeba;">{{ message }}</li>
                {% endfor %}
                </ul>
              {% endif %}
            {% endwith %}

            <div id="calendar-wrapper">
                <div id="calendar"></div>
            </div>

            <div class="agenda-section" id="agenda-section">
                <input type="text" id="event-search" class="event-search" placeholder="Buscar evento na lista...">

                <div class="agenda-header">
                    <h2 id="event-list-title">Todos os Eventos</h2>
                    <button id="show-all-btn" class="simple-btn hidden">Mostrar Todos</button>
                </div>

                <div class="agenda-list" id="agenda-list">
                    {% if eventos_data %}
                        {% for evento in eventos_data %}
                        <div class="agenda-item" data-date="{{ evento.data_iso }}">
                            <div class="agenda-date">
                                <span class="agenda-day">{{ evento.data.split('/')[0] if evento.data else '?' }}</span>
                                <span class="agenda-month">{{ evento.mes_curto if evento.mes_curto else '???' }}</span>
                            </div>
                            <div class="agenda-details">
                                <h3 class="agenda-title">{{ evento.evento if evento.evento else 'Evento sem descrição' }}</h3>
                                
                                {% if evento.data_fim and evento.data_fim != evento.data_iso %}
                                    <p class="agenda-full-date" style="display: block; font-size: 0.8em; color: #888; margin-top: 3px;">
                                        Até: {{ evento.data_fim | format_date_br }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-events-message">Nenhum evento carregado. Verifique o arquivo 'calendario.txt'.</p>
                    {% endif %}
                </div>
                <p class="no-events-message" id="no-filter-results" style="display: none; margin-top: 15px;">
                    Nenhum evento encontrado para a data ou busca selecionada.
                </p>
            </div>

        </section>
    </main>

    <img src="{{ url_for('static', filename='lumi_mascote.jpg') }}" alt="Mascote Lumi" class="mascote">

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. PREPARAÇÃO DOS DADOS (Vindos do Flask) ---
        const eventosData = {{ eventos_data|tojson | safe }};

        // Formata os dados do Flask para o formato que FullCalendar espera
        const eventosFormatadosParaFullCalendar = eventosData.map(evento => {
            const fcEvent = {
                title: evento.evento || 'Evento', // 'evento' é a descrição
                start: evento.data_iso,          // 'data_iso' é YYYY-MM-DD
                extendedProps: {                 // Guarda dados extras
                    data_br: evento.data,        // DD/MM/YYYY
                    data_fim_iso: evento.data_fim, // YYYY-MM-DD (data final)
                    mes_curto: evento.mes_curto
                }
            };
            
            // Adiciona data final para o FullCalendar se existir e for diferente
            // Lembre-se: 'end' no FullCalendar é EXCLUSIVO (o dia seguinte ao último dia)
            if (evento.data_fim && evento.data_fim !== evento.data_iso) {
                try {
                    // Interpreta a data final como UTC
                    let endDate = new Date(evento.data_fim + 'T00:00:00Z'); 
                    // Adiciona 1 dia para o 'end' exclusivo do FullCalendar
                    endDate.setUTCDate(endDate.getUTCDate() + 1); 
                    fcEvent.end = endDate.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                } catch(e) { 
                    console.warn("Não foi possível processar a data final:", evento.data_fim); 
                }
            }
            return fcEvent;
        });

        // --- 2. INICIALIZAÇÃO DO FULLCALENDAR ---
        const calendarEl = document.getElementById('calendar');
        let calendar = null; 
        try {
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listWeek'
                },
                buttonText: {
                    today: 'Hoje', month: 'Mês', week: 'Semana', list: 'Lista'
                },
                events: eventosFormatadosParaFullCalendar,
                selectable: true,
                fixedWeekCount: false,
                dayMaxEvents: true, // Mostra "+X eventos" se não couberem

                // --- Ações ---
                dateClick: function(info) { // Clicar num dia
                    filterEventsByDate(info.dateStr); // info.dateStr é YYYY-MM-DD
                    scrollToAgenda();
                    highlightSelectedDay(info.dayEl); // Destaca o dia clicado
                },
                eventClick: function(info) { // Clicar num evento
                    info.jsEvent.preventDefault(); 
                    const startISO = info.event.start ? info.event.start.toISOString().split('T')[0] : null;
                    if(startISO){
                        filterEventsByDate(startISO); // Filtra pela data de início
                        scrollToAgenda();
                        const dayEl = calendarEl.querySelector(`.fc-day[data-date="${startISO}"]`);
                        highlightSelectedDay(dayEl || info.el.closest('.fc-daygrid-day'));
                    }
                },
                 eventMouseEnter: function(info) { // Mostrar tooltip ao passar o mouse
                    let title = info.event.title;
                    if (info.event.end) { 
                        const startStr = info.event.start.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                        let endDate = new Date(info.event.end); 
                        endDate.setUTCDate(endDate.getUTCDate() - 1); // Volta 1 dia (pois 'end' é exclusivo)
                        const endStr = endDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                        if (startStr !== endStr) { title += ` (${startStr} - ${endStr})`; }
                    }
                    info.el.setAttribute('title', title); // Tooltip padrão do navegador
                 }
            });

            calendar.render(); // Desenha o calendário
            console.log("FullCalendar renderizado com sucesso.");

        } catch (error) {
            console.error("Erro ao inicializar o FullCalendar:", error);
            document.getElementById('calendar-wrapper').innerHTML = '<p class="no-events-message" style="color: red;">Erro ao carregar o componente do calendário.</p>';
        }

        // --- 3. FUNCIONALIDADE DA LISTA DE AGENDA (Controlada pelo JS) ---
        
        // Seletores dos elementos da Agenda
        const searchInput = document.getElementById('event-search');
        const agendaListContainer = document.getElementById('agenda-list');
        const allEventItems = agendaListContainer.querySelectorAll('.agenda-item');
        const eventListTitle = document.getElementById('event-list-title');
        const showAllBtn = document.getElementById('show-all-btn');
        const noFilterResultsMessage = document.getElementById('no-filter-results');
        const initialNoEventsMessage = document.querySelector('.no-events-message'); // A mensagem vinda do Flask
        
        // --- Funções Helper ---

        // Converte "YYYY-MM-DD" para um objeto Date em UTC (para comparações seguras)
        function parseDateISO(str) { 
            if (!str) return null;
            try {
                const [year, month, day] = str.split('-').map(Number);
                return new Date(Date.UTC(year, month - 1, day));
            } catch (e) { return null; }
        }

        // Rola a página até a lista de agenda
        function scrollToAgenda() {
            const agendaSection = document.getElementById('agenda-section');
            if (agendaSection) {
                 agendaSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Destaca o dia clicado no FullCalendar
        function highlightSelectedDay(dayElement) {
            document.querySelectorAll('.fc-daygrid-day.fc-day-selected').forEach(el => el.classList.remove('fc-day-selected'));
            if (dayElement && dayElement.classList.contains('fc-daygrid-day')) {
                dayElement.classList.add('fc-day-selected');
            }
        }

        // Mostra ou esconde a mensagem "Nenhum resultado"
        function updateNoEventsMessage(show) {
            if (noFilterResultsMessage) {
                noFilterResultsMessage.style.display = show ? 'block' : 'none';
            }
            // Esconde a lista inteira se não houver resultados para o filtro
            agendaListContainer.style.display = show ? 'none' : 'block';
            
            // Garante que a mensagem original (se houver) seja escondida
            if(initialNoEventsMessage && show) {
                initialNoEventsMessage.style.display = 'none';
            }
        }

        // Função: Filtra a lista de agenda por data
        function filterEventsByDate(dateISO) { // dateISO é YYYY-MM-DD
            let hasEventsOnDate = false;
            const dateClicked = parseDateISO(dateISO); // Data clicada (UTC)
            if (!dateClicked) return;

            const [year, month, day] = dateISO.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            eventListTitle.textContent = `Eventos para ${formattedDate}`;
            showAllBtn.classList.remove('hidden');
            searchInput.value = ''; // Limpa a busca

            allEventItems.forEach(item => {
                const itemStartDateISO = item.dataset.date; // Data de início do item
                
                // Tenta pegar a data final (se existir no HTML)
                const itemEndDateElement = item.querySelector('.agenda-full-date');
                let itemEndDateISO = itemStartDateISO; // Assume data única por padrão
                if (itemEndDateElement && itemEndDateElement.textContent.includes('Até: ')) {
                    try {
                        const dateParts = itemEndDateElement.textContent.split(': ')[1].split('/'); // DD/MM/YYYY
                        itemEndDateISO = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // Converte para YYYY-MM-DD
                    } catch (e) { /* Usa data de início se falhar */ }
                }

                const itemStartDate = parseDateISO(itemStartDateISO);
                const itemEndDate = parseDateISO(itemEndDateISO);

                // Verifica se a data clicada está DENTRO do intervalo do evento
                if (itemStartDate && itemEndDate && dateClicked >= itemStartDate && dateClicked <= itemEndDate) {
                    item.style.display = 'flex';
                    hasEventsOnDate = true;
                } else {
                    item.style.display = 'none';
                }
            });

            updateNoEventsMessage(!hasEventsOnDate); // Mostra msg se 'hasEventsOnDate' for falso
            if (!hasEventsOnDate) {
                 eventListTitle.textContent = `Nenhum evento para ${formattedDate}`;
            }
        }

        // Função: Mostra todos os eventos (limpa filtros)
        function showAllEvents() {
            eventListTitle.textContent = 'Todos os Eventos';
            showAllBtn.classList.add('hidden');
            searchInput.value = '';
            
            allEventItems.forEach(item => {
                item.style.display = 'flex';
            });

            // Esconde a mensagem de "sem resultados"
            updateNoEventsMessage(false); 
            // Mostra a mensagem de "sem eventos" original APENAS se não houver NENHUM evento
            if(initialNoEventsMessage) {
                initialNoEventsMessage.style.display = allEventItems.length === 0 ? 'block' : 'none';
            }
            if (allEventItems.length > 0) {
                 agendaListContainer.style.display = 'block';
            }
            
            highlightSelectedDay(null); // Remove destaque do calendário
        }

        // --- 4. EVENT LISTENERS ---

        // Botão "Mostrar Todos"
        showAllBtn.addEventListener('click', showAllEvents);

        // Campo de busca por texto
        searchInput.addEventListener('keyup', function () {
            const filter = searchInput.value.toLowerCase();
            showAllBtn.classList.toggle('hidden', filter === ''); 
            eventListTitle.textContent = filter === '' ? 'Todos os Eventos' : 'Resultados da Busca';
            let foundCount = 0;

            allEventItems.forEach(item => {
                const eventoText = item.querySelector('.agenda-title').textContent.toLowerCase();
                if (eventoText.includes(filter)) {
                    item.style.display = 'flex';
                    foundCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            updateNoEventsMessage(foundCount === 0);
            if (filter === '') { showAllEvents(); } // Restaura tudo se apagar a busca
            highlightSelectedDay(null); // Remove destaque do calendário
        });

        // --- 5. ESTADO INICIAL ---
        // Garante que a mensagem de "sem resultados de filtro" comece escondida
        updateNoEventsMessage(false);
        // Garante que a mensagem "Nenhum evento carregado" (do Flask) só apareça se for verdade
        if (initialNoEventsMessage) {
             initialNoEventsMessage.style.display = allEventItems.length === 0 ? 'block' : 'none';
        }

    }); // end DOMContentLoaded listener
    </script>
</body>
</html>