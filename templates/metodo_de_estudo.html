<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi – Método de Estudo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .quiz-container {
            width: 100%; max-width: 800px; background: white; border-radius: 15px;
            padding: 30px 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin: 50px auto 40px auto;
            position: relative;
        }
        .quiz-container h1 { text-align: center; color: #4B8BEA; margin-bottom: 10px; font-size: 2em; }
        .quiz-container > p { text-align: center; color: #666; font-size: 1.1em; margin-bottom: 30px; }

        #quiz-area p#pergunta-texto { font-size: 1.1em; font-weight: 500; color: #333; margin-bottom: 20px; }
        .options-container { display: flex; flex-direction: column; gap: 12px; }
        .option-label {
            display: flex; align-items: center; background: #f0f5ff;
            padding: 12px 18px; border-radius: 10px; border: 2px solid transparent;
            cursor: pointer; transition: 0.2s ease;
        }
        .option-label:hover { background: #e6edff; }
        .option-label input[type="checkbox"] {
            margin-right: 12px; flex-shrink: 0; transform: scale(1.1); accent-color: #4B8BEA;
        }
        .option-label.selected { background: #e0e8ff; border-color: #4B8BEA; font-weight: 500; }

        .quiz-nav { display: flex; justify-content: space-between; margin-top: 30px; }
        .quiz-nav button {
            padding: 10px 20px; background: #4B8BEA; color: white;
            border: none; border-radius: 8px; cursor: pointer; transition: 0.3s;
        }
        .quiz-nav button.prev-btn { background: #f0f0f0; color: #555; }
        .quiz-nav button:hover { opacity: 0.9; }
        .quiz-nav button:disabled { background: #ccc; cursor: not-allowed; }

        #resultado-area h2 { text-align: center; color: #2c3e50; font-size: 1.8em; margin-bottom: 20px; }
        #resultado-area p#resultado-descricao {
            color: #555; line-height: 1.6; font-size: 1em;
            margin-bottom: 25px; text-align: justify;
        }
        #resultado-area h3 { color: #4B8BEA; margin-top: 30px; margin-bottom: 15px; }
        #resultado-area ul { list-style: none; padding-left: 5px; }
        #resultado-area li {
            margin-bottom: 12px; font-size: 0.95em; position: relative; padding-left: 25px;
        }
        #resultado-area li::before {
            content: "✔"; color: #34D399; font-weight: bold; position: absolute; left: 0;
        }

        #chart-container { width: 100%; max-width: 350px; margin: 25px auto; }

        .restart-btn {
            display: block; width: 200px; margin: 30px auto;
            padding: 12px 20px; background: #555; color: white;
            border-radius: 8px; text-align: center;
        }

        #error-area h1 { color: #dc3545; }
        #error-area .restart-btn { background-color: #6c757d; }
        .hidden { display: none; }
    </style>
</head>

<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="{{ url_for('static', filename='lumi-4.png') }}" class="sidebar-avatar">
            <h3>Menu Lumi</h3>
        </div>

        <a href="{{ url_for('index') }}">Chat Principal</a>
        <a href="{{ url_for('profile') }}">Meu Perfil</a>
        <a href="{{ url_for('calendario') }}">Calendário</a>
        <a href="{{ url_for('flashcards') }}">Flashcards</a>
        <a class="active" href="{{ url_for('metodo_de_estudo') }}">Método de Estudo</a>
        <a href="{{ url_for('simulador') }}" class="active">Simulador de Provas</a>
        <a href="{{ url_for('modo_foco') }}">Modo Foco</a>
        <a href="{{ url_for('faq') }}">FAQ</a>
    </nav>

    <div class="overlay"></div>

    <header>
        <button class="menu-toggle"><span class="hamburger-icon"></span></button>

        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='lumi_logo.jpg') }}" class="logo">
        </a>

        {% if current_user.is_authenticated %}
        <div class="user-area">
            <span class="username">Olá, {{ current_user.username.split(' ')[0] }}</span>
            <a href="{{ url_for('profile') }}">
                <div class="profile-picture">
                    {% set image_filename = 'uploads/' + current_user.profile_image if current_user.profile_image != 'lumi-2.png' else 'lumi-2.png' %}
                    <img src="{{ url_for('static', filename=image_filename) }}" class="profile-img">
                </div>
            </a>
        </div>
        {% endif %}
    </header>

    <main class="faq-page">
        <section class="quiz-container">

            <a href="{{ url_for('index') }}" class="back-link-profile-glued-final">
                &larr; Voltar para o Chat
            </a>

            <!-- QUIZ -->
            <div id="quiz-area">
                <h1 id="quiz-titulo">Carregando Quiz...</h1>
                <p id="quiz-descricao"></p>
                <hr>
                <p id="pergunta-texto">Carregando pergunta...</p>
                <div class="options-container" id="options-container"></div>

                <div class="quiz-nav">
                    <button id="prev-btn" class="prev-btn" disabled>Anterior</button>
                    <span id="question-counter">-- / --</span>
                    <button id="next-btn" disabled>Próxima</button>
                    <button id="finish-btn" class="hidden" disabled>Finalizar</button>
                </div>
            </div>

            <!-- RESULTADOS -->
            <div id="resultado-area" class="hidden">
                <h2>Seu resultado: <span id="resultado-titulo"></span></h2>

                <div id="chart-container"><canvas id="vark-chart"></canvas></div>
                <p id="resultado-descricao"></p>

                <h3>Métodos de Estudo Recomendados:</h3>
                <ul id="resultado-metodos"></ul>

                <button id="restart-btn" class="restart-btn">Refazer Quiz</button>
            </div>

            <!-- ERRO -->
            <div id="error-area" class="hidden">
                <h1>Oops! Algo deu errado.</h1>
                <p id="error-msg">Erro ao inicializar o quiz.</p>
                <a href="{{ url_for('index') }}" class="restart-btn">Voltar ao Início</a>
            </div>

        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // Seletores — AGORA SEM back-btn-global
            const quizArea = document.getElementById('quiz-area');
            const resultadoArea = document.getElementById('resultado-area');
            const errorArea = document.getElementById('error-area');

            const quizTitulo = document.getElementById('quiz-titulo');
            const quizDescricao = document.getElementById('quiz-descricao');
            const perguntaTexto = document.getElementById('pergunta-texto');
            const optionsContainer = document.getElementById('options-container');
            const questionCounter = document.getElementById('question-counter');

            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');
            const restartBtn = document.getElementById('restart-btn');

            const resultadoTitulo = document.getElementById('resultado-titulo');
            const resultadoDescricao = document.getElementById('resultado-descricao');
            const resultadoMetodos = document.getElementById('resultado-metodos');

            const chartCtx = document.getElementById('vark-chart').getContext('2d');
            let varkChart = null;

            let currentQuestion = 0;
            let userAnswers = {};
            let perguntas = [];
            let resultadosVARK = {};

            const flaskQuizData = {{ quiz_data | tojson | safe }};
            const savedResultData = {{ saved_vark_result | tojson | safe }};

            try {
                if (!flaskQuizData || !flaskQuizData.perguntas || !flaskQuizData.resultados)
                    throw new Error("Dados essenciais não carregados.");

                perguntas = flaskQuizData.perguntas;
                resultadosVARK = flaskQuizData.resultados;

                initializeQuizOrResult();

            } catch (error) {
                console.error(error);
                showError(error.message);
            }

            function initializeQuizOrResult() {
                if (savedResultData && savedResultData.primaryType) {
                    displayResult(savedResultData.scores, savedResultData.primaryType);
                    quizArea.classList.add('hidden');
                    resultadoArea.classList.remove('hidden');
                    return;
                }
                quizTitulo.textContent = flaskQuizData.titulo;
                quizDescricao.textContent = flaskQuizData.descricao;
                showQuestion(0);
            }

            function showError(msg) {
                quizArea.classList.add('hidden');
                resultadoArea.classList.add('hidden');
                errorArea.classList.remove('hidden');
                document.getElementById("error-msg").textContent = msg;
            }

            function showQuestion(i) {
                perguntaTexto.textContent = perguntas[i].texto;
                optionsContainer.innerHTML = "";

                perguntas[i].opcoes.forEach(opt => {
                    const label = document.createElement("label");
                    label.className = "option-label";

                    const input = document.createElement("input");
                    input.type = "checkbox";
                    input.value = opt.tipo;

                    input.addEventListener("change", () => {
                        if (!userAnswers[i]) userAnswers[i] = [];
                        if (input.checked) {
                            userAnswers[i].push(opt.tipo);
                        } else {
                            userAnswers[i] = userAnswers[i].filter(x => x !== opt.tipo);
                        }
                        label.classList.toggle("selected", input.checked);
                        updateButtons();
                    });

                    label.appendChild(input);
                    label.appendChild(document.createTextNode(opt.texto));
                    optionsContainer.appendChild(label);
                });

                questionCounter.textContent = `${i + 1} / ${perguntas.length}`;
                updateButtons();
            }

            function updateButtons() {
                prevBtn.disabled = currentQuestion === 0;

                const answered = userAnswers[currentQuestion] && userAnswers[currentQuestion].length > 0;

                if (currentQuestion === perguntas.length - 1) {
                    nextBtn.classList.add("hidden");
                    finishBtn.classList.remove("hidden");
                    finishBtn.disabled = !answered;
                } else {
                    finishBtn.classList.add("hidden");
                    nextBtn.classList.remove("hidden");
                    nextBtn.disabled = !answered;
                }
            }

            nextBtn.onclick = () => {
                currentQuestion++;
                showQuestion(currentQuestion);
            };

            prevBtn.onclick = () => {
                currentQuestion--;
                showQuestion(currentQuestion);
            };

            finishBtn.onclick = async () => {
                const scores = { V: 0, A: 0, R: 0, K: 0 };

                Object.values(userAnswers).forEach(list => {
                    if (list) list.forEach(t => scores[t]++);
                });

                let max = Math.max(scores.V, scores.A, scores.R, scores.K);
                let primary = Object.keys(scores).filter(k => scores[k] === max).join("/");

                displayResult(scores, primary);

                try {
                    await fetch("/save_vark_result", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ scores, primaryType: primary })
                    });
                } catch(err) { console.error(err); }

                quizArea.classList.add("hidden");
                resultadoArea.classList.remove("hidden");
            };

            function displayResult(scores, primary) {
                resultadoTitulo.textContent = primary;

                let descricao = "";
                let metodos = new Set();

                primary.split("/").forEach(t => {
                    if (resultadosVARK[t]) {
                        descricao += resultadosVARK[t].descricao + "<br><br>";
                        resultadosVARK[t].metodos.forEach(m => metodos.add(m));
                    }
                });

                resultadoDescricao.innerHTML = descricao;
                resultadoMetodos.innerHTML = "";

                metodos.forEach(m => {
                    const li = document.createElement("li");
                    li.textContent = m;
                    resultadoMetodos.appendChild(li);
                });

                if (varkChart) varkChart.destroy();
                varkChart = new Chart(chartCtx, {
                    type: "doughnut",
                    data: {
                        labels: ["V", "A", "R", "K"],
                        datasets: [{
                            data: [scores.V, scores.A, scores.R, scores.K],
                            backgroundColor: ["#4B8BEA", "#34D399", "#F59E0B", "#EF4444"]
                        }]
                    }
                });
            }

            restartBtn.onclick = () => {
                userAnswers = {};
                currentQuestion = 0;
                resultadoArea.classList.add("hidden");
                quizArea.classList.remove("hidden");
                showQuestion(0);
            };

        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.overlay');

            if (menuToggle && sidebar && overlay) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
        })
    </script>

</body>
</html>
